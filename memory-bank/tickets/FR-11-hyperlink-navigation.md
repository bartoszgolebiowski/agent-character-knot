# FR-11: Hyperlink Navigation

**Status:** Not Started  
**Priority:** Medium  
**Epic:** Presentation & Output  
**Story Points:** 2

---

## Description

All character names and chapter references throughout the HTML report must be rendered as **clickable hyperlinks** that navigate to the corresponding character or chapter page. This creates a seamless, Wikipedia-like browsing experience where users can:

- Click on a character name to jump to their full profile
- Click on a chapter reference to see that chapter's events and context
- Explore the relationship network by following connections

This requirement ensures the report isn't just a collection of static pages, but an **interconnected knowledge graph** that users can explore interactively.

The hyperlinking must be:

- **Automatic:** Generated by the HTML report tool, not manually coded
- **Consistent:** All instances of a character/chapter reference are hyperlinked
- **Robust:** Links must point to valid files (no broken links)

---

## Acceptance Criteria

### Business Criteria

1. **AC-1:** In the character index table, every character name is a hyperlink to that character's dedicated page (e.g., `<a href="uuid-123.html">Gandalf</a>`).

2. **AC-2:** In relationship tables, both character names in each relationship are hyperlinked.

3. **AC-3:** In chapter pages, all character names mentioned in events are hyperlinked to their profiles.

4. **AC-4:** In character pages, all chapter references (e.g., "Chapter 5") in the interaction history are hyperlinked to the chapter page.

5. **AC-5:** All hyperlinks use relative paths (not absolute URLs) so the report can be moved/hosted anywhere.

6. **AC-6:** There are no broken links (all href targets exist in the generated file set).

7. **AC-7:** Navigation works when viewing files locally (file:// protocol) and when hosted on a web server.

---

## Technical Description

### Implementation Approach

Hyperlinking is implemented through **Jinja2 template logic** and **custom filters** that automatically generate correct href values.

#### 1. **Link Generation Patterns**

**Character Links:**

```html
<a href="{{ character_id }}.html">{{ character_name }}</a>
```

**Chapter Links:**

```html
<a href="chapter-{{ "%03d" | format(chapter_index) }}.html">{{ chapter_title }}</a>
```

**Breadcrumb/Navigation:**

```html
<a href="index.html">← Back to Index</a>
```

#### 2. **Jinja2 Custom Filters**

In the HTML report generator, register custom filters to simplify template logic:

```python
# In src/tools/html_report_generator.py

def setup_jinja_environment(self, template_dir: str, state: AgentState) -> Environment:
    """Configure Jinja2 with custom filters for hyperlinking."""
    env = Environment(
        loader=FileSystemLoader(template_dir),
        autoescape=True
    )

    # Filter: Convert character ID to hyperlinked name
    def character_link(char_id: str, text: str | None = None) -> str:
        """Generate hyperlink to character page."""
        if char_id not in state.semantic.characters:
            return f"[Unknown Character: {char_id}]"

        char = state.semantic.characters[char_id]
        display_text = text or char.canonical_name
        return f'<a href="{char_id}.html">{display_text}</a>'

    # Filter: Convert chapter index to hyperlinked title
    def chapter_link(chapter_index: int, text: str | None = None) -> str:
        """Generate hyperlink to chapter page."""
        chapter_file = f"chapter-{chapter_index:03d}.html"

        # Find chapter metadata for title
        chapter_meta = next(
            (c for c in state.working.chapter_map if c.index == chapter_index),
            None
        )

        display_text = text or (
            chapter_meta.title if chapter_meta else f"Chapter {chapter_index}"
        )

        return f'<a href="{chapter_file}">{display_text}</a>'

    # Filter: Get character name from ID (for non-linked contexts)
    def character_name(char_id: str) -> str:
        """Get character canonical name."""
        return state.semantic.characters.get(char_id, {}).canonical_name or "Unknown"

    # Register filters
    env.filters['character_link'] = character_link
    env.filters['chapter_link'] = chapter_link
    env.filters['character_name'] = character_name

    return env
```

#### 3. **Template Usage Examples**

**In Index Template:**

```html
<tbody>
  {% for char in characters %}
  <tr>
    <td>{{ char.id | character_link }}</td>
    <td>{{ char.importance_score }}</td>
    <td>{{ char.first_appearance_chapter | chapter_link }}</td>
  </tr>
  {% endfor %}
</tbody>
```

**In Character Template:**

```html
<h3>Relationship with {{ other_id | character_link }}</h3>

<table>
  {% for interaction in history.interactions %}
  <tr>
    <td>{{ interaction.evidence.chapter_index | chapter_link }}</td>
    <td>{{ interaction.relation_type }}</td>
  </tr>
  {% endfor %}
</table>
```

**In Chapter Template:**

```html
<p>
  Involved characters: {% for char_id in event.involved_characters %} {{ char_id
  | character_link }}{% if not loop.last %}, {% endif %} {% endfor %}
</p>
```

#### 4. **Alternative: Use Jinja2 Macros**

For more complex link patterns, define reusable macros:

```jinja
{# templates/report/macros.html.j2 #}

{% macro character_link(char_id, all_characters, custom_text=None) %}
    {% set char = all_characters[char_id] %}
    <a href="{{ char_id }}.html" class="character-link">
        {{ custom_text or char.canonical_name }}
    </a>
{% endmacro %}

{% macro chapter_link(chapter_index, chapter_map, custom_text=None) %}
    {% set chapter = chapter_map[chapter_index] %}
    <a href="chapter-{{ "%03d" | format(chapter_index) }}.html" class="chapter-link">
        {{ custom_text or chapter.title }}
    </a>
{% endmacro %}
```

**Usage in templates:**

```html
{% import "macros.html.j2" as macros %} {{ macros.character_link(char_id,
all_characters) }} {{ macros.chapter_link(5, chapter_map, "See Chapter 5") }}
```

#### 5. **Link Validation**

Add a validation step after report generation:

```python
# In src/tools/html_report_generator.py

def validate_links(self, output_dir: Path, generated_files: list[str]) -> list[str]:
    """
    Check for broken links in generated HTML files.

    Returns list of broken links (empty if all valid).
    """
    from html.parser import HTMLParser

    broken_links = []

    class LinkExtractor(HTMLParser):
        def __init__(self):
            super().__init__()
            self.links = []

        def handle_starttag(self, tag, attrs):
            if tag == 'a':
                for attr, value in attrs:
                    if attr == 'href':
                        self.links.append(value)

    for file_path in generated_files:
        parser = LinkExtractor()
        content = Path(file_path).read_text(encoding="utf-8")
        parser.feed(content)

        # Check each link
        for link in parser.links:
            # Skip external links
            if link.startswith('http'):
                continue

            # Skip anchors
            if link.startswith('#'):
                continue

            # Check if target file exists
            target = output_dir / link
            if not target.exists():
                broken_links.append(f"{file_path} -> {link} (NOT FOUND)")

    return broken_links
```

#### 6. **Relative vs. Absolute Paths**

For portability, use **relative paths**:

```html
<!-- GOOD: Works in any directory -->
<a href="character-uuid-123.html">Gandalf</a>
<a href="chapter-005.html">Chapter 5</a>

<!-- BAD: Only works if hosted at specific location -->
<a href="/reports/output/character-uuid-123.html">Gandalf</a>
```

#### 7. **Breadcrumb Navigation**

Add consistent navigation to all pages:

```html
<nav class="breadcrumb">
  <a href="index.html">Home</a>
  {% if current_page == "character" %} ›
  <a href="index.html#characters">Characters</a> › {{ character.canonical_name
  }} {% elif current_page == "chapter" %} ›
  <a href="index.html#chapters">Chapters</a>
  › {{ chapter.title }} {% endif %}
</nav>
```

#### 8. **CSS for Link Styling**

```css
/* templates/report/static/style.css */

a {
  color: #3498db;
  text-decoration: none;
  transition: color 0.2s;
}

a:hover {
  color: #2980b9;
  text-decoration: underline;
}

a:visited {
  color: #9b59b6;
}

.breadcrumb a {
  color: #7f8c8d;
  margin: 0 5px;
}

.character-link {
  font-weight: bold;
}

.chapter-link {
  font-style: italic;
}
```

### Architecture Compliance

- **Template-Based:** All link generation in Jinja2 templates
- **No Hardcoded URLs:** Links generated from state data
- **Custom Filters:** Encapsulate link logic in reusable functions
- **Validation:** Post-generation check for broken links
- **Deterministic Tool:** Part of HTML report generator (no LLM)

### Testing Strategy

1. **Unit Test - Link Generators:**
   - Test `character_link` filter with valid/invalid IDs
   - Test `chapter_link` filter with various indices
   - Verify correct HTML output

2. **Integration Test - Full Report:**
   - Generate report from sample state
   - Parse all HTML files
   - Extract all `<a>` tags
   - Verify all `href` targets exist

3. **Manual Test - Navigation:**
   - Open `index.html` in browser
   - Click random character → verify lands on correct page
   - Click random chapter → verify lands on correct page
   - Check browser console for 404 errors

4. **Edge Case Tests:**
   - Character with no relationships (no links to break)
   - Chapter with no events (ensure page still generates)
   - Characters with special characters in names (URL encoding)

---

## Dependencies

- `FR-10` (Multi-Page HTML Report) - Must be implemented first
- Jinja2 environment setup
- HTML parser library for validation (built-in `html.parser`)

---

## Questions / Clarifications Needed

- Should we implement "back to top" links on long pages?
- Do we need to handle external links (e.g., to Wikipedia) for character names?
- Should we add "next/previous chapter" navigation buttons on chapter pages?
- Do we want to highlight the current page in navigation menus?
- Should broken link validation be a fatal error (stop generation) or just a warning?
- Do we need URL encoding for character names with special characters?
